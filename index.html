<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tanakh Gematria Browser</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 20px;
            padding: 20px;
        }

        /* Left Panel */
        .left-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
        }

        .nav-controls {
            margin-bottom: 20px;
        }

        .nav-controls select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .options-section {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .options-section h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }

        .display-modes {
            margin: 10px 0;
        }

        .display-modes label {
            display: block;
            margin: 5px 0;
            cursor: pointer;
        }

        .advanced-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .btn {
            padding: 8px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .method-groups {
            margin-top: 20px;
        }

        .method-group {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .method-group h4 {
            margin-bottom: 8px;
            color: #555;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .method-checkbox {
            display: block;
            margin: 5px 0;
            font-size: 13px;
        }

        .method-checkbox input {
            margin-right: 5px;
        }

        /* Center Panel */
        .center-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            direction: rtl;
        }

        .verse-display {
            font-size: 28px;
            line-height: 1.8;
            font-family: 'Frank Ruhl Libre', serif;
            text-align: justify;
            margin: 20px 0;
            min-height: 200px;
        }

        .word-token {
            display: inline-block;
            padding: 5px 8px;
            margin: 3px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
            position: relative;
        }

        .word-token:hover {
            background: #e3f2fd;
            transform: scale(1.05);
        }

        .word-token.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .verse-info {
            text-align: center;
            margin-bottom: 20px;
            color: #666;
            font-size: 18px;
        }

        .selection-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        /* Right Panel */
        .right-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
        }

        .results-section {
            margin-bottom: 20px;
        }

        .results-section h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .gematria-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 10px;
        }

        .gematria-table th,
        .gematria-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        .gematria-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .gematria-table tr:hover {
            background: #f8f9fa;
        }

        .value-cell {
            font-weight: 600;
            color: #764ba2;
            text-align: right;
        }

        /* Search/Calculate Box */
        .search-section {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .search-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .search-input:focus {
            border-color: #667eea;
            outline: none;
        }

        /* Milui Dialog */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideIn 0.3s;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .modal-header h2 {
            color: #333;
        }

        .close-modal {
            font-size: 24px;
            cursor: pointer;
            color: #999;
            transition: color 0.2s;
        }

        .close-modal:hover {
            color: #333;
        }

        .milui-options {
            display: grid;
            gap: 15px;
        }

        .milui-letter {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .milui-letter h4 {
            margin-bottom: 8px;
            color: #555;
            font-size: 18px;
        }

        .milui-choice {
            margin: 5px 0;
        }

        .milui-choice label {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .multi-select-toggle label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .multi-select-toggle {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }

        .multi-select-toggle label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 250px 1fr 300px;
            }
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .left-panel, .right-panel {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> Tanakh Gematria Browser</h1>
            <p>Instant gematria values for every word and verse</p>
        </div>

        <div class="main-content">
            <!-- Left Panel -->
            <div class="left-panel">
                <div class="nav-controls">
                    <select id="bookSelect">
                        <option value="genesis">Genesis</option>
                        <option value="exodus">Exodus</option>
                        <option value="leviticus">Leviticus</option>
                        <option value="numbers">Numbers</option>
                        <option value="deuteronomy">Deuteronomy</option>
                    </select>
                    <select id="chapterSelect">
                        <option value="1">Chapter 1</option>
                        <option value="2">Chapter 2</option>
                    </select>
                    <select id="verseSelect">
                        <option value="1">Verse 1</option>
                        <option value="2">Verse 2</option>
                        <option value="3">Verse 3</option>
                    </select>
                </div>

                <div class="options-section">
                    <h3>Display Options</h3>
                    <div class="display-modes">
                        <label>
                            <input type="radio" name="displayMode" value="letters" checked>
                            Letters only
                        </label>
                        <label>
                            <input type="radio" name="displayMode" value="no-trope">
                            Without cantillation
                        </label>
                        <label>
                            <input type="radio" name="displayMode" value="raw">
                            Full text
                        </label>
                    </div>
                </div>

                <div class="multi-select-toggle">
                    <label>
                        <input type="checkbox" id="multiSelectMode">
                        Multi-select mode
                    </label>
                </div>

                <div class="advanced-buttons">
                    <button class="btn" onclick="openMiluiDialog()">Milui Settings</button>
                    <button class="btn" onclick="clearSelection()">Clear Selection</button>
                    <!-- Transformation controls: apply letter-substitution ciphers to displayed text -->
                    <div style="margin-top:10px;">
                        <select id="transformSelect" title="Select a letter-substitution cipher to apply">
                            <option value="none">No transformation</option>
                            <option value="atbash">Atbash</option>
                            <option value="albam">Albam</option>
                            <option value="achbi">AchBi</option>
                            <option value="avgad">Avgad</option>
                            <option value="reverse_avgad">Reverse Avgad</option>
                        </select>
                        <button class="btn" style="margin-left:5px;" onclick="applyTransformation()">Apply Transform</button>
                    </div>
                </div>

                <div class="method-groups">
                    <div class="method-group">
                        <h4>
                            Standard Methods
                            <span>
                                <a href="#" onclick="toggleGroup('standard', true); return false;">All</a> |
                                <a href="#" onclick="toggleGroup('standard', false); return false;">None</a>
                            </span>
                        </h4>
                        <label class="method-checkbox">
                            <input type="checkbox" value="hechrachi" checked> Hechrachi (Standard)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="gadol" checked> Gadol (Large)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="siduri" checked> Siduri (Ordinal)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="katan" checked> Katan (Small)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="perati"> Perati (Squared)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="meshulash"> Meshulash (Cubed)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="kidmi"> Kidmi (Triangular)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="mispari"> Mispari (Spelled)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="boneh"> Bone'eh (Building)
                        </label>
                    </div>

                    <div class="method-group">
                        <h4>
                            Milui Methods
                            <span>
                                <a href="#" onclick="toggleGroup('milui', true); return false;">All</a> |
                                <a href="#" onclick="toggleGroup('milui', false); return false;">None</a>
                            </span>
                        </h4>
                        <label class="method-checkbox">
                            <input type="checkbox" value="shemi"> Shemi (Letter Names)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="neelam"> Ne'elam (Hidden)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="ofanim"> Ofanim (Endings)
                        </label>
                    </div>

                    <div class="method-group">
                        <h4>
                            Transformations
                            <span>
                                <a href="#" onclick="toggleGroup('transform', true); return false;">All</a> |
                                <a href="#" onclick="toggleGroup('transform', false); return false;">None</a>
                            </span>
                        </h4>
                        <label class="method-checkbox">
                            <input type="checkbox" value="atbash"> Atbash
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="albam"> Albam
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="achbi"> Achbi
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="avgad"> Avgad
                        </label>
                    </div>

                    <div class="method-group">
                        <h4>
                            Live Methods
                            <span>
                                <a href="#" onclick="toggleGroup('live', true); return false;">All</a> |
                                <a href="#" onclick="toggleGroup('live', false); return false;">None</a>
                            </span>
                        </h4>
                        <label class="method-checkbox">
                            <input type="checkbox" value="kolel"> Kolel (+Words)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="musafi"> Musafi (+Letters)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="klali"> Klali (Squared Sum)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="haachor"> Ha'achor (Positional)
                        </label>
                    </div>
                </div>

                <div class="search-section">
                    <h3>Live Calculation</h3>
                    <input type="text" class="search-input" id="calculateInput" placeholder="Enter word or phrase...">
                    <button class="btn" onclick="calculateLive()">Calculate</button>
                </div>
            </div>

            <!-- Center Panel -->
            <div class="center-panel">
                <div class="verse-info">
                    <strong>Genesis Chapter 1, Verse 1</strong>
                </div>
                <div class="verse-display" id="verseDisplay">
                    <!-- Verse will be rendered here -->
                </div>
                <div class="selection-controls">
                    <button class="btn" onclick="selectAll()">Select All</button>
                    <button class="btn" onclick="clearSelection()">Clear Selection</button>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <div class="results-section">
                    <h3>Selection Summary</h3>
                    <table class="gematria-table" id="selectionTable">
                        <thead>
                            <tr>
                                <th>Method</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody id="selectionResults">
                            <!-- Results will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <div class="results-section">
                    <h3>Word Details</h3>
                    <table class="gematria-table" id="wordDetailsTable">
                        <thead>
                            <tr>
                                <th>Word</th>
                                <th>Hechrachi Value</th>
                            </tr>
                        </thead>
                        <tbody id="wordDetails">
                            <!-- Word details will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Milui Dialog -->
    <div id="miluiModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Milui (Letter Spelling) Settings</h2>
                <span class="close-modal" onclick="closeMiluiDialog()">&times;</span>
            </div>
            <div class="milui-options">
                <div class="milui-letter">
                    <h4> - Alef</h4>
                    <div class="milui-choice">
                        <label><input type="radio" name="milui_alef" value="祝" checked> 祝 (111)</label>
                    </div>
                </div>
                <div class="milui-letter">
                    <h4> - Bet</h4>
                    <div class="milui-choice">
                        <label><input type="radio" name="milui_bet" value="转" checked> 转 (412)</label>
                    </div>
                    <div class="milui-choice">
                        <label><input type="radio" name="milui_bet" value="转"> 转 (402)</label>
                    </div>
                </div>
                <div class="milui-letter">
                    <h4> - Gimel</h4>
                    <div class="milui-choice">
                        <label><input type="radio" name="milui_gimel" value="" checked>  (73)</label>
                    </div>
                    <div class="milui-choice">
                        <label><input type="radio" name="milui_gimel" value="">  (73)</label>
                    </div>
                </div>
                <div class="milui-letter">
                    <h4> - Heh</h4>
                    <div class="milui-choice">
                        <label><input type="radio" name="milui_heh" value="" checked>  (6)</label>
                    </div>
                    <div class="milui-choice">
                        <label><input type="radio" name="milui_heh" value="">  (15)</label>
                    </div>
                    <div class="milui-choice">
                        <label><input type="radio" name="milui_heh" value="">  (10)</label>
                    </div>
                </div>
                <div class="milui-letter">
                    <h4> - Vav</h4>
                    <div class="milui-choice">
                        <label><input type="radio" name="milui_vav" value="" checked>  (12)</label>
                    </div>
                    <div class="milui-choice">
                        <label><input type="radio" name="milui_vav" value="">  (22)</label>
                    </div>
                    <div class="milui-choice">
                        <label><input type="radio" name="milui_vav" value="">  (13)</label>
                    </div>
                </div>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn" onclick="applyMiluiSettings()">Apply</button>
                <button class="btn" onclick="resetMiluiDefaults()">Reset to Defaults</button>
            </div>
        </div>
    </div>

    <script>
        // Gematria Engine
        const GematriaEngine = {
            // Letter value tables
            values: {
                hechrachi: {
                    '': 1, '': 2, '': 3, '': 4, '': 5, '': 6, '': 7, '': 8, '': 9,
                    '': 10, '': 20, '': 20, '': 30, '': 40, '': 40, '': 50, '': 50,
                    '住': 60, '注': 70, '驻': 80, '祝': 80, '爪': 90, '抓': 90, '拽': 100, '专': 200,
                    '砖': 300, '转': 400
                },
                gadol: {
                    '': 1, '': 2, '': 3, '': 4, '': 5, '': 6, '': 7, '': 8, '': 9,
                    '': 10, '': 20, '': 500, '': 30, '': 40, '': 600, '': 50, '': 700,
                    '住': 60, '注': 70, '驻': 80, '祝': 800, '爪': 90, '抓': 900, '拽': 100, '专': 200,
                    '砖': 300, '转': 400
                },
                siduri: {
                    '': 1, '': 2, '': 3, '': 4, '': 5, '': 6, '': 7, '': 8, '': 9,
                    '': 10, '': 11, '': 11, '': 12, '': 13, '': 13, '': 14, '': 14,
                    '住': 15, '注': 16, '驻': 17, '祝': 17, '爪': 18, '抓': 18, '拽': 19, '专': 20,
                    '砖': 21, '转': 22
                },
                katan: {
                    '': 1, '': 2, '': 3, '': 4, '': 5, '': 6, '': 7, '': 8, '': 9,
                    '': 1, '': 2, '': 2, '': 3, '': 4, '': 4, '': 5, '': 5,
                    '住': 6, '注': 7, '驻': 8, '祝': 8, '爪': 9, '抓': 9, '拽': 1, '专': 2,
                    '砖': 3, '转': 4
                },
                mispari: {
                    '': 13, '': 760, '': 636, '': 273, '': 348, '': 322, '': 372, '': 401, '': 770,
                    '': 570, '': 620, '': 620, '': 686, '': 280, '': 280, '': 348, '': 348,
                    '住': 720, '注': 422, '驻': 446, '祝': 446, '爪': 720, '抓': 720, '拽': 186, '专': 580,
                    '砖': 930, '转': 1000
                }
            },

            // Transformation tables
            transforms: {
                atbash: {
                    '': '转', '': '砖', '': '专', '': '拽', '': '爪', '': '驻', '': '注', '': '住', '': '',
                    '': '', '': '', '': '', '': '', '': '', '住': '', '注': '', '驻': '', '爪': '',
                    '拽': '', '专': '', '砖': '', '转': '', '': '', '': '', '': '', '祝': '', '抓': ''
                },
                albam: {
                    '': '', '': '', '': '', '': '住', '': '注', '': '驻', '': '爪', '': '拽', '': '专',
                    '': '砖', '': '转', '': '', '': '', '': '', '住': '', '注': '', '驻': '', '爪': '',
                    '拽': '', '专': '', '砖': '', '转': '', '': '转', '': '', '': '', '祝': '', '抓': ''
                },
                achbi: {
                    '': '', '': '', '': '', '': '', '': '', '': '', '': '', '': '', '': '',
                    '': '', '': '', '': '转', '': '砖', '': '专', '住': '拽', '注': '爪', '驻': '驻', '爪': '注',
                    '拽': '住', '专': '', '砖': '', '转': '', '': '', '': '砖', '': '专', '祝': '驻', '抓': '注'
                },
                avgad: {
                    '': '', '': '', '': '', '': '', '': '', '': '', '': '', '': '', '': '',
                    '': '', '': '', '': '', '': '', '': '住', '住': '注', '注': '驻', '驻': '爪', '爪': '拽',
                    '拽': '专', '专': '砖', '砖': '转', '转': '', '': '', '': '', '': '住', '祝': '爪', '抓': '拽'
                }
            },

            // Reverse Avgad mapping (letter to previous letter, wrapping around)
            reverseAvgadMap: {
                '': '转', '': '', '': '', '': '', '': '', '': '', '': '', '': '', '': '',
                '': '', '': '', '': '', '': '', '': '', '住': '', '注': '住', '驻': '注', '爪': '驻',
                '拽': '爪', '专': '拽', '砖': '专', '转': '砖', '': '', '': '', '': '', '祝': '驻', '抓': '爪'
            },

            // Milui (letter spellings)
            milui: {
                defaults: {
                    '': '祝', '': '转', '': '', '': '转', '': '',
                    '': '', '': '', '': '转', '': '转', '': '',
                    '': '祝', '': '祝', '': '', '': '', '': '',
                    '': '', '': '', '住': '住', '注': '注', '驻': '驻',
                    '祝': '驻', '爪': '爪', '抓': '爪', '拽': '拽祝', '专': '专砖',
                    '砖': '砖', '转': '转'
                },
                current: {} // Will be populated with defaults
            },

            // Initialize milui settings
            init() {
                this.milui.current = {...this.milui.defaults};
            },

            // Calculate methods
            calculate(text, method) {
                const letters = this.getLettersOnly(text);
                
                switch(method) {
                    case 'hechrachi':
                    case 'gadol':
                    case 'siduri':
                    case 'katan':
                    case 'mispari':
                        return this.simpleSum(letters, this.values[method]);
                    
                    case 'perati':
                        return this.calculatePerati(letters);
                    
                    case 'meshulash':
                        return this.calculateMeshulash(letters);
                    
                    case 'kidmi':
                        return this.calculateKidmi(letters);
                    
                    case 'boneh':
                        return this.calculateBoneh(letters);
                    
                    case 'shemi':
                        return this.calculateShemi(letters);
                    
                    case 'neelam':
                        return this.calculateNeelam(letters);
                    
                    case 'ofanim':
                        return this.calculateOfanim(letters);
                    
                    case 'atbash':
                    case 'albam':
                    case 'achbi':
                    case 'avgad':
                    case 'reverse_avgad':
                        return this.calculateTransform(letters, method);
                    
                    case 'kolel':
                        return this.calculateKolel(text);
                    
                    case 'musafi':
                        return this.calculateMusafi(text);
                    
                    case 'klali':
                        return this.calculateKlali(text);
                    
                    case 'haachor':
                        return this.calculateHaachor(text);
                    
                    default:
                        return 0;
                }
            },

            getLettersOnly(text) {
                return text.replace(/[^-转]/g, '');
            },

            simpleSum(letters, valueTable) {
                let sum = 0;
                for (let letter of letters) {
                    sum += valueTable[letter] || 0;
                }
                return sum;
            },

            calculatePerati(letters) {
                let sum = 0;
                for (let letter of letters) {
                    const val = this.values.hechrachi[letter] || 0;
                    sum += val * val;
                }
                return sum;
            },

            calculateMeshulash(letters) {
                let sum = 0;
                for (let letter of letters) {
                    const val = this.values.hechrachi[letter] || 0;
                    sum += val * val * val;
                }
                return sum;
            },

            calculateKidmi(letters) {
                let sum = 0;
                for (let letter of letters) {
                    const ordinal = this.values.siduri[letter] || 0;
                    sum += (ordinal * (ordinal + 1)) / 2;
                }
                return sum;
            },

            calculateBoneh(letters) {
                let sum = 0;
                let running = 0;
                for (let letter of letters) {
                    running += this.values.hechrachi[letter] || 0;
                    sum += running;
                }
                return sum;
            },

            calculateShemi(letters) {
                let sum = 0;
                for (let letter of letters) {
                    const spelling = this.milui.current[letter];
                    if (spelling) {
                        for (let l of spelling) {
                            sum += this.values.hechrachi[l] || 0;
                        }
                    }
                }
                return sum;
            },

            calculateNeelam(letters) {
                let sum = 0;
                for (let letter of letters) {
                    const spelling = this.milui.current[letter];
                    if (spelling && spelling.length > 1) {
                        // Sum all but first letter
                        for (let i = 1; i < spelling.length; i++) {
                            sum += this.values.hechrachi[spelling[i]] || 0;
                        }
                    }
                }
                return sum;
            },

            calculateOfanim(letters) {
                let sum = 0;
                for (let letter of letters) {
                    const spelling = this.milui.current[letter];
                    if (spelling && spelling.length > 0) {
                        // Add value of last letter
                        sum += this.values.hechrachi[spelling[spelling.length - 1]] || 0;
                    }
                }
                return sum;
            },

            calculateTransform(letters, transform) {
                // Special handling for reverse_avgad: use reverseAvgadMap
                let transformed = '';
                if (transform === 'reverse_avgad') {
                    for (let letter of letters) {
                        transformed += this.reverseAvgadMap[letter] || letter;
                    }
                } else {
                    for (let letter of letters) {
                        const map = this.transforms[transform];
                        transformed += (map && map[letter]) ? map[letter] : letter;
                    }
                }
                return this.simpleSum(transformed, this.values.hechrachi);
            },

            calculateKolel(text) {
                const words = text.trim().split(/\s+/);
                const letterSum = this.simpleSum(this.getLettersOnly(text), this.values.hechrachi);
                return letterSum + words.length;
            },

            calculateMusafi(text) {
                const letters = this.getLettersOnly(text);
                const letterSum = this.simpleSum(letters, this.values.hechrachi);
                return letterSum + letters.length;
            },

            calculateKlali(text) {
                const letterSum = this.simpleSum(this.getLettersOnly(text), this.values.hechrachi);
                return letterSum * letterSum;
            },

            calculateHaachor(text) {
                const letters = this.getLettersOnly(text);
                let sum = 0;
                for (let i = 0; i < letters.length; i++) {
                    const letterValue = this.values.hechrachi[letters[i]] || 0;
                    sum += letterValue * (letters.length - i);
                }
                return sum;
            },

            /**
             * Apply a letter-substitution cipher to a string. Returns the transformed string.
             * If transformName is 'none' or not provided, returns the original text.
             * Supported transformations are defined in this.transforms (e.g. atbash, albam, achbi, avgad)
             * and reverseAvgadMap for reverse Avgad (maps to previous letter).
             * @param {string} text Input string
             * @param {string} transformName Name of the transformation ('atbash', 'albam', 'achbi', 'avgad', 'reverse_avgad')
             * @returns {string} The transformed string
             */
            applyTransform(text, transformName) {
                if (!text || !transformName || transformName === 'none') return text;
                let result = '';
                // Remove non-Hebrew characters for transformation
                const letters = this.getLettersOnly(text);
                for (let i = 0; i < letters.length; i++) {
                    const ch = letters[i];
                    let newChar;
                    if (transformName === 'reverse_avgad') {
                        newChar = this.reverseAvgadMap[ch] || ch;
                    } else {
                        const map = this.transforms[transformName];
                        newChar = map && map[ch] ? map[ch] : ch;
                    }
                    result += newChar;
                }
                return result;
            }
        };

        // Sample data
        const sampleData = {
            genesis: {
                1: {
                    1: {
                        text_raw: "职旨专值砖执转 指旨专指 直止执 值转 址砖指旨址执 职值转 指指专侄抓",
                        text_no_trope: "专砖转 专  转 砖 转 专抓",
                        text_letters_only: "专砖转 专  转 砖 转 专抓",
                        tokens: [
                            {t: "专砖转", n: 6},
                            {t: "专", n: 3},
                            {t: "", n: 5},
                            {t: "转", n: 2},
                            {t: "砖", n: 5},
                            {t: "转", n: 3},
                            {t: "专抓", n: 4}
                        ]
                    },
                    2: {
                        text_raw: "职指指专侄抓 指职转指 转止旨 指止旨 职止砖侄职 注址志驻职旨值 转职止 职专旨址 直止执 职专址侄驻侄转 注址志驻职旨值 址指旨执",
                        text_no_trope: "专抓 转 转  砖 注 驻 转 专  专驻转 注 驻 ",
                        text_letters_only: "专抓 转 转  砖 注 驻 转 专  专驻转 注 驻 ",
                        tokens: [
                            {t: "专抓", n: 5},
                            {t: "转", n: 4},
                            {t: "转", n: 3},
                            {t: "", n: 4},
                            {t: "砖", n: 4},
                            {t: "注", n: 2},
                            {t: "驻", n: 3},
                            {t: "转", n: 4},
                            {t: "专", n: 4},
                            {t: "", n: 5},
                            {t: "专驻转", n: 5},
                            {t: "注", n: 2},
                            {t: "驻", n: 3},
                            {t: "", n: 4}
                        ]
                    },
                    3: {
                        text_raw: "址止旨侄专 直止执 职执 止专 址职执志止专",
                        text_no_trope: "专   专  专",
                        text_letters_only: "专   专  专",
                        tokens: [
                            {t: "专", n: 5},
                            {t: "", n: 5},
                            {t: "", n: 3},
                            {t: "专", n: 3},
                            {t: "", n: 4},
                            {t: "专", n: 3}
                        ]
                    }
                }
            }
        };

        // UI State
        let currentBook = 'genesis';
        let currentChapter = 1;
        let currentVerse = 1;
        let selectedTokens = new Set();
        let multiSelectMode = false;
        // Currently selected transformation (letter-substitution cipher)
        let currentTransform = 'none';

        // Initialize
        GematriaEngine.init();

        // Render verse
        function renderVerse() {
            const verseData = sampleData[currentBook][currentChapter][currentVerse];
            const verseDisplay = document.getElementById('verseDisplay');
            const displayMode = document.querySelector('input[name="displayMode"]:checked').value;
            
            verseDisplay.innerHTML = '';
            
            verseData.tokens.forEach((token, index) => {
                const span = document.createElement('span');
                span.className = 'word-token';
                span.dataset.index = index;
                span.dataset.word = token.t;
                
                // Choose display text based on mode
                // Determine base text for this token based on display mode
                let baseText;
                if (displayMode === 'letters') {
                    baseText = token.t;
                } else if (displayMode === 'no-trope') {
                    // For this demo, we only have letters-only data
                    baseText = token.t;
                } else {
                    baseText = token.t;
                }
                // Apply transformation if selected
                let displayText = baseText;
                if (currentTransform && currentTransform !== 'none') {
                    displayText = GematriaEngine.applyTransform(baseText, currentTransform);
                }
                span.textContent = displayText;
                
                if (selectedTokens.has(index)) {
                    span.classList.add('selected');
                }
                
                span.onclick = (e) => selectWord(e, index);
                verseDisplay.appendChild(span);
            });
            
            updateResults();
        }

        // Select word
        function selectWord(event, index) {
            const multiSelect = document.getElementById('multiSelectMode').checked;
            
            if (event.ctrlKey || event.metaKey || multiSelect) {
                // Toggle selection
                if (selectedTokens.has(index)) {
                    selectedTokens.delete(index);
                } else {
                    selectedTokens.add(index);
                }
            } else {
                // Single selection
                selectedTokens.clear();
                selectedTokens.add(index);
            }
            
            renderVerse();
        }

        // Clear selection
        function clearSelection() {
            selectedTokens.clear();
            renderVerse();
        }

        // Select all
        function selectAll() {
            const verseData = sampleData[currentBook][currentChapter][currentVerse];
            selectedTokens.clear();
            for (let i = 0; i < verseData.tokens.length; i++) {
                selectedTokens.add(i);
            }
            renderVerse();
        }

        // Update results
        function updateResults() {
            const verseData = sampleData[currentBook][currentChapter][currentVerse];
            const checkedMethods = getCheckedMethods();
            
            // Get selected text or full verse
            let text = '';
            if (selectedTokens.size > 0) {
                const selectedWords = [];
                selectedTokens.forEach(index => {
                    selectedWords.push(verseData.tokens[index].t);
                });
                text = selectedWords.join(' ');
            } else {
                text = verseData.text_letters_only;
            }
            
            // Update selection table
            const selectionResults = document.getElementById('selectionResults');
            selectionResults.innerHTML = '';
            
            checkedMethods.forEach(method => {
                const value = GematriaEngine.calculate(text, method);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${getMethodLabel(method)}</td>
                    <td class="value-cell">${value.toLocaleString()}</td>
                `;
                selectionResults.appendChild(row);
            });
            
            // Update word details
            const wordDetails = document.getElementById('wordDetails');
            wordDetails.innerHTML = '';
            
            if (selectedTokens.size > 0) {
                selectedTokens.forEach(index => {
                    const token = verseData.tokens[index];
                    const value = GematriaEngine.calculate(token.t, 'hechrachi');
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${token.t}</td>
                        <td class="value-cell">${value.toLocaleString()}</td>
                    `;
                    wordDetails.appendChild(row);
                });
            }
        }

        // Get checked methods
        function getCheckedMethods() {
            const methods = [];
            document.querySelectorAll('.method-checkbox input:checked').forEach(checkbox => {
                methods.push(checkbox.value);
            });
            return methods;
        }

        // Get method label
        function getMethodLabel(method) {
            const labels = {
                hechrachi: 'Hechrachi (Standard)',
                gadol: 'Gadol (Large)',
                siduri: 'Siduri (Ordinal)',
                katan: 'Katan (Small)',
                perati: 'Perati (Squared)',
                meshulash: 'Meshulash (Cubed)',
                kidmi: 'Kidmi (Triangular)',
                mispari: 'Mispari (Spelled)',
                boneh: 'Bone\'eh (Building)',
                shemi: 'Shemi (Letter Names)',
                neelam: 'Ne\'elam (Hidden)',
                ofanim: 'Ofanim (Endings)',
                atbash: 'Atbash',
                albam: 'Albam',
                achbi: 'Achbi',
                avgad: 'Avgad',
                reverse_avgad: 'Reverse Avgad',
                kolel: 'Kolel (+Words)',
                musafi: 'Musafi (+Letters)',
                klali: 'Klali (Squared Sum)',
                haachor: 'Ha\'achor (Positional)'
            };
            return labels[method] || method;
        }

        // Toggle method group
        function toggleGroup(group, checked) {
            const groupMap = {
                standard: ['hechrachi', 'gadol', 'siduri', 'katan', 'perati', 'meshulash', 'kidmi', 'mispari', 'boneh'],
                milui: ['shemi', 'neelam', 'ofanim'],
                transform: ['atbash', 'albam', 'achbi', 'avgad'],
                live: ['kolel', 'musafi', 'klali', 'haachor']
            };
            
            const methods = groupMap[group] || [];
            methods.forEach(method => {
                const checkbox = document.querySelector(`input[value="${method}"]`);
                if (checkbox) {
                    checkbox.checked = checked;
                }
            });
            
            updateResults();
        }

        // Calculate live
        function calculateLive() {
            const input = document.getElementById('calculateInput').value;
            if (!input) return;
            
            const checkedMethods = getCheckedMethods();
            let resultsHtml = '<h4>Results for: ' + input + '</h4><table class="gematria-table"><tbody>';
            
            checkedMethods.forEach(method => {
                const value = GematriaEngine.calculate(input, method);
                resultsHtml += `
                    <tr>
                        <td>${getMethodLabel(method)}</td>
                        <td class="value-cell">${value.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            resultsHtml += '</tbody></table>';
            
            // Display results in a temporary modal
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = resultsHtml;
            Object.assign(tempDiv.style, {
                position: 'fixed',
                top: '50%',
                left: '50%',
                transform: 'translate(-50%, -50%)',
                background: 'white',
                padding: '20px',
                borderRadius: '10px',
                boxShadow: '0 10px 30px rgba(0,0,0,0.3)',
                zIndex: 2000,
                maxHeight: '70vh',
                overflow: 'auto'
            });
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Close';
            closeBtn.className = 'btn';
            closeBtn.onclick = () => document.body.removeChild(tempDiv);
            tempDiv.appendChild(closeBtn);
            document.body.appendChild(tempDiv);

            // Also display the input text in the verse display area so users can apply transforms to it
            const verseDisplay = document.getElementById('verseDisplay');
            verseDisplay.innerHTML = '';
            const words = input.trim().split(/\s+/);
            words.forEach((word, idx) => {
                const span = document.createElement('span');
                span.className = 'word-token';
                span.dataset.index = idx;
                span.dataset.word = word;
                // Apply transformation if selected
                let displayWord = word;
                if (currentTransform && currentTransform !== 'none') {
                    displayWord = GematriaEngine.applyTransform(word, currentTransform);
                }
                span.textContent = displayWord;
                verseDisplay.appendChild(span);
            });
        }

        /**
         * Apply a letter-substitution cipher transformation to the currently displayed verse or typed input.
         * The transformation is selected via the #transformSelect dropdown. Updates the UI accordingly.
         */
        function applyTransformation() {
            const select = document.getElementById('transformSelect');
            currentTransform = select ? select.value : 'none';
            // Re-render verse display to show transformed text
            renderVerse();
        }

        // Milui dialog functions
        function openMiluiDialog() {
            document.getElementById('miluiModal').classList.add('active');
        }

        function closeMiluiDialog() {
            document.getElementById('miluiModal').classList.remove('active');
        }

        function applyMiluiSettings() {
            // Update milui settings based on selections
            const radioGroups = {
                'milui_alef': '',
                'milui_bet': '',
                'milui_gimel': '',
                'milui_heh': '',
                'milui_vav': ''
            };
            
            for (let [groupName, letter] of Object.entries(radioGroups)) {
                const selected = document.querySelector(`input[name="${groupName}"]:checked`);
                if (selected) {
                    GematriaEngine.milui.current[letter] = selected.value;
                }
            }
            
            closeMiluiDialog();
            updateResults();
        }

        function resetMiluiDefaults() {
            GematriaEngine.milui.current = {...GematriaEngine.milui.defaults};
            // Reset radio buttons
            document.querySelectorAll('.milui-choice input[type="radio"]:first-child').forEach(radio => {
                radio.checked = true;
            });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Display mode changes
            document.querySelectorAll('input[name="displayMode"]').forEach(radio => {
                radio.addEventListener('change', renderVerse);
            });
            
            // Method checkboxes
            document.querySelectorAll('.method-checkbox input').forEach(checkbox => {
                checkbox.addEventListener('change', updateResults);
            });
            
            // Navigation controls
            document.getElementById('verseSelect').addEventListener('change', (e) => {
                currentVerse = parseInt(e.target.value);
                renderVerse();
            });
            
            // Initial render
            renderVerse();
        });

        // Close modal when clicking outside
        window.onclick = (event) => {
            const modal = document.getElementById('miluiModal');
            if (event.target === modal) {
                closeMiluiDialog();
            }
        };
    </script>
</body>
</html>