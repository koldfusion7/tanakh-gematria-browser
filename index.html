<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tanakh Gematria Browser</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 20px;
            padding: 20px;
        }

        /* Left Panel */
        .left-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
        }

        .nav-controls {
            margin-bottom: 20px;
        }

        .nav-controls select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .options-section {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .options-section h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }

        .display-modes {
            margin: 10px 0;
        }

        .display-modes label {
            display: block;
            margin: 5px 0;
            cursor: pointer;
        }

        .advanced-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .btn {
            padding: 8px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .method-groups {
            margin-top: 20px;
        }

        .method-group {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .method-group h4 {
            margin-bottom: 8px;
            color: #555;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .method-checkbox {
            display: block;
            margin: 5px 0;
            font-size: 13px;
        }

        .method-checkbox input {
            margin-right: 5px;
        }

        /* Center Panel */
        .center-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            direction: rtl;
        }

        .verse-display {
            font-size: 28px;
            line-height: 1.8;
            font-family: 'Frank Ruhl Libre', serif;
            text-align: justify;
            margin: 20px 0;
            min-height: 200px;
        }

        .word-token {
            display: inline-block;
            padding: 5px 8px;
            margin: 3px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
            position: relative;
        }

        .word-token:hover {
            background: #e3f2fd;
            transform: scale(1.05);
        }

        .word-token.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .verse-info {
            text-align: center;
            margin-bottom: 20px;
            color: #666;
            font-size: 18px;
        }

        .selection-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        /* Right Panel */
        .right-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
        }

        .results-section {
            margin-bottom: 20px;
        }

        .results-section h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .gematria-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 10px;
        }

        .gematria-table th,
        .gematria-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        .gematria-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .gematria-table tr:hover {
            background: #f8f9fa;
        }

        .value-cell {
            font-weight: 600;
            color: #764ba2;
            text-align: right;
        }

        /* Search/Calculate Box */
        .search-section {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .search-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .search-input:focus {
            border-color: #667eea;
            outline: none;
        }

        /* Milui Dialog */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideIn 0.3s;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .modal-header h2 {
            color: #333;
        }

        .close-modal {
            font-size: 24px;
            cursor: pointer;
            color: #999;
            transition: color 0.2s;
        }

        .close-modal:hover {
            color: #333;
        }

        .milui-options {
            display: grid;
            gap: 15px;
        }

        .milui-letter {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .milui-letter h4 {
            margin-bottom: 8px;
            color: #555;
            font-size: 18px;
        }

        .milui-choice {
            margin: 5px 0;
        }

        .milui-choice label {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .multi-select-toggle label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .multi-select-toggle {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }

        .multi-select-toggle label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 250px 1fr 300px;
            }
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .left-panel, .right-panel {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìñ Tanakh Gematria Browser</h1>
            <p>Instant gematria values for every word and verse</p>
        </div>

        <div class="main-content">
            <!-- Left Panel -->
            <div class="left-panel">
                <div class="nav-controls">
                    <select id="bookSelect">
                        <option value="genesis">Genesis</option>
                        <option value="exodus">Exodus</option>
                        <option value="leviticus">Leviticus</option>
                        <option value="numbers">Numbers</option>
                        <option value="deuteronomy">Deuteronomy</option>
                    </select>
                    <select id="chapterSelect">
                        <option value="1">Chapter 1</option>
                        <option value="2">Chapter 2</option>
                    </select>
                    <select id="verseSelect">
                        <option value="1">Verse 1</option>
                        <option value="2">Verse 2</option>
                        <option value="3">Verse 3</option>
                    </select>
                </div>

                <div class="options-section">
                    <h3>Display Options</h3>
                    <div class="display-modes">
                        <label>
                            <input type="radio" name="displayMode" value="letters" checked>
                            Letters only
                        </label>
                        <label>
                            <input type="radio" name="displayMode" value="no-trope">
                            Without cantillation
                        </label>
                        <label>
                            <input type="radio" name="displayMode" value="raw">
                            Full text
                        </label>
                    </div>
                </div>

                <div class="multi-select-toggle">
                    <label>
                        <input type="checkbox" id="multiSelectMode">
                        Multi-select mode
                    </label>
                </div>

                <div class="advanced-buttons">
                    <button class="btn" onclick="openMiluiDialog()">Milui Settings</button>
                    <button class="btn" onclick="clearSelection()">Clear Selection</button>
                    <!-- Transformation controls: apply letter-substitution ciphers to displayed text -->
                    <div style="margin-top:10px;">
                        <select id="transformSelect" title="Select a letter-substitution cipher to apply">
                            <option value="none">No transformation</option>
                            <option value="atbash">Atbash</option>
                            <option value="albam">Albam</option>
                            <option value="achbi">AchBi</option>
                            <option value="atbach">AtBach</option>
                            <option value="ayak_bachar">Ayak Bachar</option>
                            <option value="achas_beta">Achas Beta</option>
                            <option value="avgad">Avgad</option>
                            <option value="reverse_avgad">Reverse Avgad</option>
                        </select>
                        <button class="btn" style="margin-left:5px;" onclick="applyTransformation()">Apply Transform</button>
                    </div>
                </div>

                <div class="method-groups">
                    <div class="method-group">
                        <h4>
                            Standard Methods
                            <span>
                                <a href="#" onclick="toggleGroup('standard', true); return false;">All</a> |
                                <a href="#" onclick="toggleGroup('standard', false); return false;">None</a>
                            </span>
                        </h4>
                        <label class="method-checkbox">
                            <input type="checkbox" value="hechrachi" checked> Hechrachi (Standard)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="gadol" checked> Gadol (Large)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="siduri" checked> Siduri (Ordinal)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="katan" checked> Katan (Small)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="perati"> Perati (Squared)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="meshulash"> Meshulash (Cubed)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="kidmi"> Kidmi (Triangular)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="mispari"> Mispari (Spelled)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="boneh"> Bone'eh (Building)
                        </label>
                    </div>

                    <div class="method-group">
                        <h4>
                            Milui Methods
                            <span>
                                <a href="#" onclick="toggleGroup('milui', true); return false;">All</a> |
                                <a href="#" onclick="toggleGroup('milui', false); return false;">None</a>
                            </span>
                        </h4>
                        <label class="method-checkbox">
                            <input type="checkbox" value="shemi"> Shemi (Letter Names)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="neelam"> Ne'elam (Hidden)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="ofanim"> Ofanim (Endings)
                        </label>
                    </div>

                    <div class="method-group">
                        <h4>
                            Transformations
                            <span>
                                <a href="#" onclick="toggleGroup('transform', true); return false;">All</a> |
                                <a href="#" onclick="toggleGroup('transform', false); return false;">None</a>
                            </span>
                        </h4>
                        <label class="method-checkbox">
                            <input type="checkbox" value="atbash"> Atbash
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="albam"> Albam
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="achbi"> Achbi
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="avgad"> Avgad
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="reverse_avgad"> Reverse Avgad
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="atbach"> AtBach
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="ayak_bachar"> Ayak Bachar
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="achas_beta"> Achas Beta
                        </label>
                    </div>

                    <div class="method-group">
                        <h4>
                            Live Methods
                            <span>
                                <a href="#" onclick="toggleGroup('live', true); return false;">All</a> |
                                <a href="#" onclick="toggleGroup('live', false); return false;">None</a>
                            </span>
                        </h4>
                        <label class="method-checkbox">
                            <input type="checkbox" value="kolel"> Kolel (+Words)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="musafi"> Musafi (+Letters)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="klali"> Klali (Squared Sum)
                        </label>
                        <label class="method-checkbox">
                            <input type="checkbox" value="haachor"> Ha'achor (Positional)
                        </label>
                    </div>
                </div>

                <div class="search-section">
                    <h3>Live Calculation</h3>
                    <input type="text" class="search-input" id="calculateInput" placeholder="Enter word or phrase...">
                    <button class="btn" onclick="calculateLive()">Calculate</button>
                </div>
            </div>

            <!-- Center Panel -->
            <div class="center-panel">
                <div class="verse-info">
                    <strong>Genesis Chapter 1, Verse 1</strong>
                </div>
                <div class="verse-display" id="verseDisplay">
                    <!-- Focus (selected or input) will be rendered here -->
                </div>
                <!-- Context display shows the original text context below the focus area -->
                <div class="context-display" id="contextDisplay" style="margin-top: 15px; padding: 10px; background: #f9fafb; border-radius: 8px; min-height: 80px;"></div>
                <div class="selection-controls">
                    <button class="btn" onclick="selectAll()">Select All</button>
                    <button class="btn" onclick="clearSelection()">Clear Selection</button>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <div class="results-section">
                    <h3>Selection Summary</h3>
                    <table class="gematria-table" id="selectionTable">
                        <thead>
                            <tr>
                                <th>Method</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody id="selectionResults">
                            <!-- Results will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <div class="results-section">
                    <h3>Word Details</h3>
                    <table class="gematria-table" id="wordDetailsTable">
                        <thead>
                            <tr>
                                <th>Word</th>
                                <th>Hechrachi Value</th>
                            </tr>
                        </thead>
                        <tbody id="wordDetails">
                            <!-- Word details will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Milui Dialog -->
    <div id="miluiModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Milui (Letter Spelling) Settings</h2>
                <span class="close-modal" onclick="closeMiluiDialog()">&times;</span>
            </div>
            <div class="milui-options">
                <div class="milui-letter">
                    <h4>◊ê - Alef</h4>
                    <div class="milui-choice">
                        <label><input type="radio" name="milui_alef" value="◊ê◊ú◊£" checked> ◊ê◊ú◊£ (111)</label>
                    </div>
                </div>
                <div class="milui-letter">
                    <h4>◊ë - Bet</h4>
                    <div class="milui-choice">
                        <label><input type="radio" name="milui_bet" value="◊ë◊ô◊™" checked> ◊ë◊ô◊™ (412)</label>
                    </div>
                    <div class="milui-choice">
                        <label><input type="radio" name="milui_bet" value="◊ë◊™"> ◊ë◊™ (402)</label>
                    </div>
                </div>
                <div class="milui-letter">
                    <h4>◊í - Gimel</h4>
                    <div class="milui-choice">
                        <label><input type="radio" name="milui_gimel" value="◊í◊ô◊û◊ú" checked> ◊í◊ô◊û◊ú (73)</label>
                    </div>
                    <div class="milui-choice">
                        <label><input type="radio" name="milui_gimel" value="◊í◊û◊ú"> ◊í◊û◊ú (73)</label>
                    </div>
                </div>
                <div class="milui-letter">
                    <h4>◊î - Heh</h4>
                    <div class="milui-choice">
                        <label><input type="radio" name="milui_heh" value="◊î◊ê" checked> ◊î◊ê (6)</label>
                    </div>
                    <div class="milui-choice">
                        <label><input type="radio" name="milui_heh" value="◊î◊ô"> ◊î◊ô (15)</label>
                    </div>
                    <div class="milui-choice">
                        <label><input type="radio" name="milui_heh" value="◊î◊î"> ◊î◊î (10)</label>
                    </div>
                </div>
                <div class="milui-letter">
                    <h4>◊ï - Vav</h4>
                    <div class="milui-choice">
                        <label><input type="radio" name="milui_vav" value="◊ï◊ï" checked> ◊ï◊ï (12)</label>
                    </div>
                    <div class="milui-choice">
                        <label><input type="radio" name="milui_vav" value="◊ï◊ô◊ï"> ◊ï◊ô◊ï (22)</label>
                    </div>
                    <div class="milui-choice">
                        <label><input type="radio" name="milui_vav" value="◊ï◊ê◊ï"> ◊ï◊ê◊ï (13)</label>
                    </div>
                </div>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn" onclick="applyMiluiSettings()">Apply</button>
                <button class="btn" onclick="resetMiluiDefaults()">Reset to Defaults</button>
            </div>
        </div>
    </div>

    <script>
        // Gematria Engine
        const GematriaEngine = {
            // Letter value tables
            values: {
                hechrachi: {
                    '◊ê': 1, '◊ë': 2, '◊í': 3, '◊ì': 4, '◊î': 5, '◊ï': 6, '◊ñ': 7, '◊ó': 8, '◊ò': 9,
                    '◊ô': 10, '◊õ': 20, '◊ö': 20, '◊ú': 30, '◊û': 40, '◊ù': 40, '◊†': 50, '◊ü': 50,
                    '◊°': 60, '◊¢': 70, '◊§': 80, '◊£': 80, '◊¶': 90, '◊•': 90, '◊ß': 100, '◊®': 200,
                    '◊©': 300, '◊™': 400
                },
                gadol: {
                    '◊ê': 1, '◊ë': 2, '◊í': 3, '◊ì': 4, '◊î': 5, '◊ï': 6, '◊ñ': 7, '◊ó': 8, '◊ò': 9,
                    '◊ô': 10, '◊õ': 20, '◊ö': 500, '◊ú': 30, '◊û': 40, '◊ù': 600, '◊†': 50, '◊ü': 700,
                    '◊°': 60, '◊¢': 70, '◊§': 80, '◊£': 800, '◊¶': 90, '◊•': 900, '◊ß': 100, '◊®': 200,
                    '◊©': 300, '◊™': 400
                },
                siduri: {
                    '◊ê': 1, '◊ë': 2, '◊í': 3, '◊ì': 4, '◊î': 5, '◊ï': 6, '◊ñ': 7, '◊ó': 8, '◊ò': 9,
                    '◊ô': 10, '◊õ': 11, '◊ö': 11, '◊ú': 12, '◊û': 13, '◊ù': 13, '◊†': 14, '◊ü': 14,
                    '◊°': 15, '◊¢': 16, '◊§': 17, '◊£': 17, '◊¶': 18, '◊•': 18, '◊ß': 19, '◊®': 20,
                    '◊©': 21, '◊™': 22
                },
                katan: {
                    '◊ê': 1, '◊ë': 2, '◊í': 3, '◊ì': 4, '◊î': 5, '◊ï': 6, '◊ñ': 7, '◊ó': 8, '◊ò': 9,
                    '◊ô': 1, '◊õ': 2, '◊ö': 2, '◊ú': 3, '◊û': 4, '◊ù': 4, '◊†': 5, '◊ü': 5,
                    '◊°': 6, '◊¢': 7, '◊§': 8, '◊£': 8, '◊¶': 9, '◊•': 9, '◊ß': 1, '◊®': 2,
                    '◊©': 3, '◊™': 4
                },
                /*
                 * Mispar Mispari ‚Äì values of letters based on the Hebrew names of the
                 * standard numeric values.  The values below are taken directly from
                 * the chart on TorahCalc‚Äôs ‚ÄúExplanations of Gematria Methods with
                 * Charts‚Äù page„Äê308932796231125‚Ä†L173-L184„Äë.  For example, the standard
                 * value of Alef (◊ê) is 1, and the Hebrew word for one is "◊ê◊ó◊ì"
                 * (Echad) which sums to 13 (1+8+4).  Likewise, Beis (◊ë) has a
                 * standard value of 2 and the Hebrew word for two is "◊©◊†◊ô◊ù" or
                 * "◊©◊™◊ô◊ù" ‚Äì in the chart the value used is 760.  These values
                 * ensure that our Mispar Mispari calculations match TorahCalc.
                 */
                mispari: {
                    /*
                     * Mispar¬†Mispari (Spelled) values.  These values are
                     * derived from the spelled‚Äëout names of the numbers 1‚Äì22
                     * (e.g. ‚Äú◊ê◊ó◊ì‚Äù = 13) and match the table on TorahCalc
                     *„Äê308932796231125‚Ä†L173-L184„Äë.  Note that these differ from
                     * some earlier drafts of this program; see the chart
                     * lines 177‚Äì184 on the TorahCalc page for confirmation.
                     */
                    '◊ê': 13,
                    '◊ë': 760,
                    '◊í': 636,
                    '◊ì': 273,
                    '◊î': 348,
                    '◊ï': 600,
                    '◊ñ': 372,
                    '◊ó': 401,
                    '◊ò': 770,
                    '◊ô': 570,
                    // Kaf and final Kaf share the same value
                    '◊õ': 620, '◊ö': 620,
                    '◊ú': 686,
                    // Mem and final Mem
                    '◊û': 323, '◊ù': 323,
                    // Nun and final Nun
                    '◊†': 408, '◊ü': 408,
                    '◊°': 660,
                    '◊¢': 422,
                    // Pe and final Pe
                    '◊§': 446, '◊£': 446,
                    // Tzadi and final Tzadi
                    '◊¶': 820, '◊•': 820,
                    '◊ß': 46,
                    '◊®': 501,
                    '◊©': 1083,
                    '◊™': 720
                }
            },

            // Transformation tables
            transforms: {
                atbash: {
                    '◊ê': '◊™', '◊ë': '◊©', '◊í': '◊®', '◊ì': '◊ß', '◊î': '◊¶', '◊ï': '◊§', '◊ñ': '◊¢', '◊ó': '◊°', '◊ò': '◊†',
                    '◊ô': '◊û', '◊õ': '◊ú', '◊ú': '◊õ', '◊û': '◊ô', '◊†': '◊ò', '◊°': '◊ó', '◊¢': '◊ñ', '◊§': '◊ï', '◊¶': '◊î',
                    '◊ß': '◊ì', '◊®': '◊í', '◊©': '◊ë', '◊™': '◊ê', '◊ö': '◊ú', '◊ù': '◊ô', '◊ü': '◊ò', '◊£': '◊ï', '◊•': '◊î'
                },
                albam: {
                    '◊ê': '◊ú', '◊ë': '◊û', '◊í': '◊†', '◊ì': '◊°', '◊î': '◊¢', '◊ï': '◊§', '◊ñ': '◊¶', '◊ó': '◊ß', '◊ò': '◊®',
                    '◊ô': '◊©', '◊õ': '◊™', '◊ú': '◊ê', '◊û': '◊ë', '◊†': '◊í', '◊°': '◊ì', '◊¢': '◊î', '◊§': '◊ï', '◊¶': '◊ñ',
                    '◊ß': '◊ó', '◊®': '◊ò', '◊©': '◊ô', '◊™': '◊õ', '◊ö': '◊™', '◊ù': '◊ë', '◊ü': '◊í', '◊£': '◊ï', '◊•': '◊ñ'
                },
                achbi: {
                    '◊ê': '◊õ', '◊ë': '◊ô', '◊í': '◊ò', '◊ì': '◊ó', '◊î': '◊ñ', '◊ï': '◊ï', '◊ñ': '◊î', '◊ó': '◊ì', '◊ò': '◊í',
                    '◊ô': '◊ë', '◊õ': '◊ê', '◊ú': '◊™', '◊û': '◊©', '◊†': '◊®', '◊°': '◊ß', '◊¢': '◊¶', '◊§': '◊§', '◊¶': '◊¢',
                    '◊ß': '◊°', '◊®': '◊†', '◊©': '◊û', '◊™': '◊ú', '◊ö': '◊ê', '◊ù': '◊©', '◊ü': '◊®', '◊£': '◊§', '◊•': '◊¢'
                },
                avgad: {
                    '◊ê': '◊ë', '◊ë': '◊í', '◊í': '◊ì', '◊ì': '◊î', '◊î': '◊ï', '◊ï': '◊ñ', '◊ñ': '◊ó', '◊ó': '◊ò', '◊ò': '◊ô',
                    '◊ô': '◊õ', '◊õ': '◊ú', '◊ú': '◊û', '◊û': '◊†', '◊†': '◊°', '◊°': '◊¢', '◊¢': '◊§', '◊§': '◊¶', '◊¶': '◊ß',
                    '◊ß': '◊®', '◊®': '◊©', '◊©': '◊™', '◊™': '◊ê', '◊ö': '◊ú', '◊ù': '◊†', '◊ü': '◊°', '◊£': '◊¶', '◊•': '◊ß'
                }
            },

            // Reverse Avgad mapping (letter to previous letter, wrapping around)
            reverseAvgadMap: {
                '◊ê': '◊™', '◊ë': '◊ê', '◊í': '◊ë', '◊ì': '◊í', '◊î': '◊ì', '◊ï': '◊î', '◊ñ': '◊ï', '◊ó': '◊ñ', '◊ò': '◊ó',
                '◊ô': '◊ò', '◊õ': '◊ô', '◊ú': '◊õ', '◊û': '◊ú', '◊†': '◊û', '◊°': '◊†', '◊¢': '◊°', '◊§': '◊¢', '◊¶': '◊§',
                '◊ß': '◊¶', '◊®': '◊ß', '◊©': '◊®', '◊™': '◊©', '◊ö': '◊õ', '◊ù': '◊û', '◊ü': '◊†', '◊£': '◊§', '◊•': '◊¶'
            },

            // Milui (letter spellings)
            milui: {
                /*
                 * Default spellings for each Hebrew letter‚Äôs name used for
                 * Mispar¬†Shemi/Ne‚Äôelam/Ofanim.  These spellings align with the
                 * names shown on TorahCalc„Äê308932796231125‚Ä†L94-L103„Äë.  Final letters
                 * reuse the same spelling as their regular form.  Users can
                 * override these via the Milui configuration dialog.
                 */
                defaults: {
                    '◊ê': '◊ê◊ú◊£',
                    '◊ë': '◊ë◊ô◊™',
                    '◊í': '◊í◊ô◊û◊ú',
                    '◊ì': '◊ì◊ú◊™',
                    '◊î': '◊î◊ê',
                    '◊ï': '◊ï◊ï',
                    '◊ñ': '◊ñ◊ô◊ü',
                    '◊ó': '◊ó◊ô◊™',
                    '◊ò': '◊ò◊ô◊™',
                    '◊ô': '◊ô◊ï◊ì',
                    '◊õ': '◊õ◊£', '◊ö': '◊õ◊£',
                    '◊ú': '◊ú◊û◊ì',
                    '◊û': '◊û◊ù', '◊ù': '◊û◊ù',
                    '◊†': '◊†◊ï◊ü', '◊ü': '◊†◊ï◊ü',
                    '◊°': '◊°◊û◊ö',
                    '◊¢': '◊¢◊ô◊ü',
                    '◊§': '◊§◊ê', '◊£': '◊§◊ê',
                    '◊¶': '◊¶◊ì◊ô', '◊•': '◊¶◊ì◊ô',
                    '◊ß': '◊ß◊ï◊£',
                    '◊®': '◊®◊ô◊©',
                    '◊©': '◊©◊ü',
                    '◊™': '◊™◊ï'
                },
                // AtBach ‚Äì three groups of nine (with finals) reversed within each group
                atbach: {
                    // Group 1: Alef ‚Üî Tet, Bet ‚Üî Chet, Gimel ‚Üî Zayin, Dalet ‚Üî Vav, Heh unchanged
                    '◊ê': '◊ò', '◊ë': '◊ó', '◊í': '◊ñ', '◊ì': '◊ï', '◊î': '◊î', '◊ï': '◊ì', '◊ñ': '◊í', '◊ó': '◊ë', '◊ò': '◊ê',
                    // Group 2 (standard letters only): Yud ‚Üî Tsadi, Kaf ‚Üî Pe, Lamed ‚Üî Ayin, Mem ‚Üî Samech, Nun unchanged
                    '◊ô': '◊¶', '◊õ': '◊§', '◊ú': '◊¢', '◊û': '◊°', '◊†': '◊†', '◊°': '◊û', '◊¢': '◊ú', '◊§': '◊õ', '◊¶': '◊ô',
                    // Group 3 (including final forms): Qof ‚Üî Final Tsadi, Resh ‚Üî Final Pe, Shin ‚Üî Final Nun, Tav ‚Üî Final Mem, Final Kaf unchanged
                    '◊ß': '◊•', '◊®': '◊£', '◊©': '◊ü', '◊™': '◊ù', '◊ö': '◊ö', '◊ù': '◊™', '◊ü': '◊©', '◊£': '◊®', '◊•': '◊ß'
                },
                // Ayak Bachar ‚Äì three groups of nine with cyclic mapping 1‚Üí2‚Üí3‚Üí1
                ayak_bachar: {
                    // Group1‚ÜíGroup2
                    '◊ê': '◊ô', '◊ë': '◊õ', '◊í': '◊ú', '◊ì': '◊û', '◊î': '◊†', '◊ï': '◊°', '◊ñ': '◊¢', '◊ó': '◊§', '◊ò': '◊¶',
                    // Group2‚ÜíGroup3
                    '◊ô': '◊ß', '◊õ': '◊®', '◊ö': '◊®', '◊ú': '◊©', '◊û': '◊™', '◊ù': '◊™', '◊†': '◊ö', '◊ü': '◊ö', '◊°': '◊ù', '◊¢': '◊ü', '◊§': '◊£', '◊£': '◊£', '◊¶': '◊•', '◊•': '◊•',
                    // Group3‚ÜíGroup1
                    '◊ß': '◊ê', '◊®': '◊ë', '◊©': '◊í', '◊™': '◊ì', '◊ö': '◊î', '◊ù': '◊ï', '◊ü': '◊ñ', '◊£': '◊ó', '◊•': '◊ò'
                },
                // Achas Beta ‚Äì three groups (7,7,8) cyclic mapping with Tav unchanged
                achas_beta: {
                    // Group1‚ÜíGroup2
                    '◊ê': '◊ó', '◊ë': '◊ò', '◊í': '◊ô', '◊ì': '◊õ', '◊î': '◊ú', '◊ï': '◊û', '◊ñ': '◊†',
                    // Group2‚ÜíGroup3
                    '◊ó': '◊°', '◊ò': '◊¢', '◊ô': '◊§', '◊õ': '◊¶', '◊ö': '◊¶', '◊ú': '◊ß', '◊û': '◊®', '◊ù': '◊®', '◊†': '◊©', '◊ü': '◊©',
                    // Group3‚ÜíGroup1 (except Tav unchanged)
                    '◊°': '◊ê', '◊¢': '◊ë', '◊§': '◊í', '◊£': '◊í', '◊¶': '◊ì', '◊•': '◊ì', '◊ß': '◊î', '◊®': '◊ï', '◊©': '◊ñ', '◊™': '◊™'
                },
                current: {} // Will be populated with defaults
            },

            // Initialize milui settings
            init() {
                this.milui.current = {...this.milui.defaults};
            },

            // Calculate methods
            calculate(text, method) {
                const letters = this.getLettersOnly(text);
                
                switch(method) {
                    case 'hechrachi':
                    case 'gadol':
                    case 'siduri':
                    case 'katan':
                    case 'mispari':
                        return this.simpleSum(letters, this.values[method]);
                    
                    case 'perati':
                        return this.calculatePerati(letters);
                    
                    case 'meshulash':
                        return this.calculateMeshulash(letters);
                    
                    case 'kidmi':
                        return this.calculateKidmi(letters);
                    
                    case 'boneh':
                        return this.calculateBoneh(letters);
                    
                    case 'shemi':
                        return this.calculateShemi(letters);
                    
                    case 'neelam':
                        return this.calculateNeelam(letters);
                    
                    case 'ofanim':
                        return this.calculateOfanim(letters);
                    
                    case 'atbash':
                    case 'albam':
                    case 'achbi':
                    case 'atbach':
                    case 'ayak_bachar':
                    case 'achas_beta':
                    case 'avgad':
                    case 'reverse_avgad':
                        return this.calculateTransform(letters, method);
                    
                    case 'kolel':
                        return this.calculateKolel(text);
                    
                    case 'musafi':
                        return this.calculateMusafi(text);
                    
                    case 'klali':
                        return this.calculateKlali(text);
                    
                    case 'haachor':
                        return this.calculateHaachor(text);
                    
                    default:
                        return 0;
                }
            },

            getLettersOnly(text) {
                return text.replace(/[^◊ê-◊™]/g, '');
            },

            simpleSum(letters, valueTable) {
                let sum = 0;
                for (let letter of letters) {
                    sum += valueTable[letter] || 0;
                }
                return sum;
            },

            calculatePerati(letters) {
                let sum = 0;
                for (let letter of letters) {
                    const val = this.values.hechrachi[letter] || 0;
                    sum += val * val;
                }
                return sum;
            },

            calculateMeshulash(letters) {
                let sum = 0;
                for (let letter of letters) {
                    const val = this.values.hechrachi[letter] || 0;
                    sum += val * val * val;
                }
                return sum;
            },

            /**
             * Mispar Kidmi ‚Äì cumulative sums of Hechrachi values up to each letter.
             * This implementation mirrors the definition used on TorahCalc: for each
             * Hebrew letter, add the sum of all standard values from Alef up to that
             * letter. Final forms are normalised to their base letter for the lookup.
             */
            calculateKidmi(letters) {
                const cumMap = {
                    '◊ê': 1,
                    '◊ë': 3,
                    '◊í': 6,
                    '◊ì': 10,
                    '◊î': 15,
                    '◊ï': 21,
                    '◊ñ': 28,
                    '◊ó': 36,
                    '◊ò': 45,
                    '◊ô': 55,
                    '◊õ': 75, '◊ö': 75,
                    '◊ú': 105,
                    '◊û': 145, '◊ù': 145,
                    '◊†': 195, '◊ü': 195,
                    '◊°': 255,
                    '◊¢': 325,
                    '◊§': 405, '◊£': 405,
                    '◊¶': 495, '◊•': 495,
                    '◊ß': 595,
                    '◊®': 795,
                    '◊©': 1095,
                    '◊™': 1495
                };
                let sum = 0;
                for (const ch of letters) {
                    // Normalise final letters to their base form for the cumulative lookup
                    let base = ch;
                    if (ch === '◊ö') base = '◊õ';
                    if (ch === '◊ù') base = '◊û';
                    if (ch === '◊ü') base = '◊†';
                    if (ch === '◊£') base = '◊§';
                    if (ch === '◊•') base = '◊¶';
                    sum += cumMap[base] || 0;
                }
                return sum;
            },

            calculateBoneh(letters) {
                let sum = 0;
                let running = 0;
                for (let letter of letters) {
                    running += this.values.hechrachi[letter] || 0;
                    sum += running;
                }
                return sum;
            },

            calculateShemi(letters) {
                let sum = 0;
                for (let letter of letters) {
                    const spelling = this.milui.current[letter];
                    if (spelling) {
                        for (let l of spelling) {
                            sum += this.values.hechrachi[l] || 0;
                        }
                    }
                }
                return sum;
            },

            calculateNeelam(letters) {
                let sum = 0;
                for (let letter of letters) {
                    const spelling = this.milui.current[letter];
                    if (spelling && spelling.length > 1) {
                        // Sum all but first letter
                        for (let i = 1; i < spelling.length; i++) {
                            sum += this.values.hechrachi[spelling[i]] || 0;
                        }
                    }
                }
                return sum;
            },

            calculateOfanim(letters) {
                let sum = 0;
                for (let letter of letters) {
                    const spelling = this.milui.current[letter];
                    if (spelling && spelling.length > 0) {
                        // Add value of last letter
                        sum += this.values.hechrachi[spelling[spelling.length - 1]] || 0;
                    }
                }
                return sum;
            },

            calculateTransform(letters, transform) {
                /*
                 * Letter‚Äësubstitution ciphers.  For most transforms we simply
                 * substitute the characters via the appropriate mapping and
                 * then sum the resulting string using the standard (Hechrachi)
                 * values.  Two ciphers ‚Äì AtBach and Ayak¬†Bachar ‚Äì require
                 * calculating the Mispar¬†Gadol of the transformed string so
                 * that any final letters take their elevated values.  The
                 * Achas¬†Beta cipher uses the standard values.  Reverse¬†Avgad
                 * uses its own dedicated map.  All other transforms (Atbash,
                 * Albam, AchBi, Avgad) use the mappings defined in
                 * GematriaEngine.transforms.
                 */
                // Reverse Avgad uses a separate map
                if (transform === 'reverse_avgad') {
                    let transformed = '';
                    for (let letter of letters) {
                        transformed += this.reverseAvgadMap[letter] || letter;
                    }
                    return this.simpleSum(transformed, this.values.hechrachi);
                }
                // AtBach and Ayak¬†Bachar: use special milui mappings and
                // compute the Mispar¬†Gadol of the result
                if (transform === 'atbach' || transform === 'ayak_bachar') {
                    let transformed = '';
                    const map = this.milui[transform];
                    for (let letter of letters) {
                        transformed += (map && map[letter]) ? map[letter] : letter;
                    }
                    return this.simpleSum(transformed, this.values.gadol);
                }
                // Achas¬†Beta: use milui mapping and standard values
                if (transform === 'achas_beta') {
                    let transformed = '';
                    const map = this.milui[transform];
                    for (let letter of letters) {
                        transformed += (map && map[letter]) ? map[letter] : letter;
                    }
                    return this.simpleSum(transformed, this.values.hechrachi);
                }
                // For Atbash, Albam, AchBi, Avgad: use the transforms table
                let transformed = '';
                const map = this.transforms[transform];
                for (let letter of letters) {
                    transformed += (map && map[letter]) ? map[letter] : letter;
                }
                return this.simpleSum(transformed, this.values.hechrachi);
            },

            calculateKolel(text) {
                const words = text.trim().split(/\s+/);
                const letterSum = this.simpleSum(this.getLettersOnly(text), this.values.hechrachi);
                return letterSum + words.length;
            },

            calculateMusafi(text) {
                const letters = this.getLettersOnly(text);
                const letterSum = this.simpleSum(letters, this.values.hechrachi);
                return letterSum + letters.length;
            },

            calculateKlali(text) {
                const letterSum = this.simpleSum(this.getLettersOnly(text), this.values.hechrachi);
                return letterSum * letterSum;
            },

            calculateHaachor(text) {
                const letters = this.getLettersOnly(text);
                let sum = 0;
                for (let i = 0; i < letters.length; i++) {
                    const letterValue = this.values.hechrachi[letters[i]] || 0;
                    sum += letterValue * (letters.length - i);
                }
                return sum;
            },

            /**
             * Apply a letter-substitution cipher to a string. Returns the transformed string.
             * If transformName is 'none' or not provided, returns the original text.
             * Supported transformations are defined in this.transforms (e.g. atbash, albam, achbi, avgad)
             * and reverseAvgadMap for reverse Avgad (maps to previous letter).
             * @param {string} text Input string
             * @param {string} transformName Name of the transformation ('atbash', 'albam', 'achbi', 'avgad', 'reverse_avgad')
             * @returns {string} The transformed string
             */
            applyTransform(text, transformName) {
                if (!text || !transformName || transformName === 'none') return text;
                // Remove non‚ÄëHebrew characters for transformation
                const letters = this.getLettersOnly(text);
                let result = '';
                if (transformName === 'reverse_avgad') {
                    // Reverse Avgad uses its own mapping
                    for (const ch of letters) {
                        result += this.reverseAvgadMap[ch] || ch;
                    }
                    return result;
                }
                // AtBach, Ayak¬†Bachar and Achas¬†Beta use the milui mapping tables
                if (transformName === 'atbach' || transformName === 'ayak_bachar' || transformName === 'achas_beta') {
                    const map = this.milui[transformName];
                    for (const ch of letters) {
                        result += (map && map[ch]) ? map[ch] : ch;
                    }
                    return result;
                }
                // For Atbash, Albam, AchBi, Avgad: use the transforms table
                const map = this.transforms[transformName];
                for (const ch of letters) {
                    result += (map && map[ch]) ? map[ch] : ch;
                }
                return result;
            }
        };

        // Sample data
        const sampleData = {
            genesis: {
                1: {
                    1: {
                        text_raw: "◊ë÷∞÷º◊®÷µ◊ê◊©÷¥◊Å◊ô◊™ ◊ë÷∏÷º◊®÷∏◊ê ◊ê÷±◊ú÷π◊î÷¥◊ô◊ù ◊ê÷µ◊™ ◊î÷∑◊©÷∏÷º◊Å◊û÷∑◊ô÷¥◊ù ◊ï÷∞◊ê÷µ◊™ ◊î÷∏◊ê÷∏◊®÷∂◊•◊É",
                        text_no_trope: "◊ë◊®◊ê◊©◊ô◊™ ◊ë◊®◊ê ◊ê◊ú◊î◊ô◊ù ◊ê◊™ ◊î◊©◊û◊ô◊ù ◊ï◊ê◊™ ◊î◊ê◊®◊•",
                        text_letters_only: "◊ë◊®◊ê◊©◊ô◊™ ◊ë◊®◊ê ◊ê◊ú◊î◊ô◊ù ◊ê◊™ ◊î◊©◊û◊ô◊ù ◊ï◊ê◊™ ◊î◊ê◊®◊•",
                        tokens: [
                            {t: "◊ë◊®◊ê◊©◊ô◊™", n: 6},
                            {t: "◊ë◊®◊ê", n: 3},
                            {t: "◊ê◊ú◊î◊ô◊ù", n: 5},
                            {t: "◊ê◊™", n: 2},
                            {t: "◊î◊©◊û◊ô◊ù", n: 5},
                            {t: "◊ï◊ê◊™", n: 3},
                            {t: "◊î◊ê◊®◊•", n: 4}
                        ]
                    },
                    2: {
                        text_raw: "◊ï÷∞◊î÷∏◊ê÷∏◊®÷∂◊• ◊î÷∏◊ô÷∞◊™÷∏◊î ◊™÷π◊î◊ï÷º ◊ï÷∏◊ë÷π◊î◊ï÷º ◊ï÷∞◊ó÷π◊©÷∂◊Å◊ö÷∞ ◊¢÷∑◊ú÷æ◊§÷∞÷º◊†÷µ◊ô ◊™÷∞◊î◊ï÷π◊ù ◊ï÷∞◊®◊ï÷º◊ó÷∑ ◊ê÷±◊ú÷π◊î÷¥◊ô◊ù ◊û÷∞◊®÷∑◊ó÷∂◊§÷∂◊™ ◊¢÷∑◊ú÷æ◊§÷∞÷º◊†÷µ◊ô ◊î÷∑◊û÷∏÷º◊ô÷¥◊ù◊É",
                        text_no_trope: "◊ï◊î◊ê◊®◊• ◊î◊ô◊™◊î ◊™◊î◊ï ◊ï◊ë◊î◊ï ◊ï◊ó◊©◊ö ◊¢◊ú ◊§◊†◊ô ◊™◊î◊ï◊ù ◊ï◊®◊ï◊ó ◊ê◊ú◊î◊ô◊ù ◊û◊®◊ó◊§◊™ ◊¢◊ú ◊§◊†◊ô ◊î◊û◊ô◊ù",
                        text_letters_only: "◊ï◊î◊ê◊®◊• ◊î◊ô◊™◊î ◊™◊î◊ï ◊ï◊ë◊î◊ï ◊ï◊ó◊©◊ö ◊¢◊ú ◊§◊†◊ô ◊™◊î◊ï◊ù ◊ï◊®◊ï◊ó ◊ê◊ú◊î◊ô◊ù ◊û◊®◊ó◊§◊™ ◊¢◊ú ◊§◊†◊ô ◊î◊û◊ô◊ù",
                        tokens: [
                            {t: "◊ï◊î◊ê◊®◊•", n: 5},
                            {t: "◊î◊ô◊™◊î", n: 4},
                            {t: "◊™◊î◊ï", n: 3},
                            {t: "◊ï◊ë◊î◊ï", n: 4},
                            {t: "◊ï◊ó◊©◊ö", n: 4},
                            {t: "◊¢◊ú", n: 2},
                            {t: "◊§◊†◊ô", n: 3},
                            {t: "◊™◊î◊ï◊ù", n: 4},
                            {t: "◊ï◊®◊ï◊ó", n: 4},
                            {t: "◊ê◊ú◊î◊ô◊ù", n: 5},
                            {t: "◊û◊®◊ó◊§◊™", n: 5},
                            {t: "◊¢◊ú", n: 2},
                            {t: "◊§◊†◊ô", n: 3},
                            {t: "◊î◊û◊ô◊ù", n: 4}
                        ]
                    },
                    3: {
                        text_raw: "◊ï÷∑◊ô÷π÷º◊ê◊û÷∂◊® ◊ê÷±◊ú÷π◊î÷¥◊ô◊ù ◊ô÷∞◊î÷¥◊ô ◊ê◊ï÷π◊® ◊ï÷∑◊ô÷∞◊î÷¥◊ô÷æ◊ê◊ï÷π◊®◊É",
                        text_no_trope: "◊ï◊ô◊ê◊û◊® ◊ê◊ú◊î◊ô◊ù ◊ô◊î◊ô ◊ê◊ï◊® ◊ï◊ô◊î◊ô ◊ê◊ï◊®",
                        text_letters_only: "◊ï◊ô◊ê◊û◊® ◊ê◊ú◊î◊ô◊ù ◊ô◊î◊ô ◊ê◊ï◊® ◊ï◊ô◊î◊ô ◊ê◊ï◊®",
                        tokens: [
                            {t: "◊ï◊ô◊ê◊û◊®", n: 5},
                            {t: "◊ê◊ú◊î◊ô◊ù", n: 5},
                            {t: "◊ô◊î◊ô", n: 3},
                            {t: "◊ê◊ï◊®", n: 3},
                            {t: "◊ï◊ô◊î◊ô", n: 4},
                            {t: "◊ê◊ï◊®", n: 3}
                        ]
                    }
                }
            }
        };

        // UI State
        let currentBook = 'genesis';
        let currentChapter = 1;
        let currentVerse = 1;
        let selectedTokens = new Set();
        let multiSelectMode = false;
        // Currently selected transformation (letter-substitution cipher)
        let currentTransform = 'none';

        // Initialize
        GematriaEngine.init();

        // Render verse
        function renderVerse() {
            const verseData = sampleData[currentBook][currentChapter][currentVerse];
            const verseDisplay = document.getElementById('verseDisplay');
            const contextDiv = document.getElementById('contextDisplay');
            const displayMode = document.querySelector('input[name="displayMode"]:checked').value;
            
            verseDisplay.innerHTML = '';
            // Update context display with the original text according to display mode
            if (contextDiv) {
                let contextText;
                if (displayMode === 'letters') {
                    contextText = verseData.text_letters_only;
                } else if (displayMode === 'no-trope') {
                    contextText = verseData.text_no_trope || verseData.text_letters_only;
                } else {
                    contextText = verseData.text_raw || verseData.text_no_trope || verseData.text_letters_only;
                }
                // Trim and normalise spaces
                contextDiv.textContent = contextText;
            }
            
            verseData.tokens.forEach((token, index) => {
                const span = document.createElement('span');
                span.className = 'word-token';
                span.dataset.index = index;
                span.dataset.word = token.t;
                
                // Choose display text based on mode
                // Determine base text for this token based on display mode
                let baseText;
                if (displayMode === 'letters') {
                    baseText = token.t;
                } else if (displayMode === 'no-trope') {
                    // For this demo, we only have letters-only data
                    baseText = token.t;
                } else {
                    baseText = token.t;
                }
                // Apply transformation if selected
                let displayText = baseText;
                if (currentTransform && currentTransform !== 'none') {
                    displayText = GematriaEngine.applyTransform(baseText, currentTransform);
                }
                span.textContent = displayText;
                
                if (selectedTokens.has(index)) {
                    span.classList.add('selected');
                }
                
                span.onclick = (e) => selectWord(e, index);
                verseDisplay.appendChild(span);
            });
            
            updateResults();
        }

        // Select word
        function selectWord(event, index) {
            const multiSelect = document.getElementById('multiSelectMode').checked;
            
            if (event.ctrlKey || event.metaKey || multiSelect) {
                // Toggle selection
                if (selectedTokens.has(index)) {
                    selectedTokens.delete(index);
                } else {
                    selectedTokens.add(index);
                }
            } else {
                // Single selection
                selectedTokens.clear();
                selectedTokens.add(index);
            }
            
            renderVerse();
        }

        // Clear selection
        function clearSelection() {
            selectedTokens.clear();
            renderVerse();
        }

        // Select all
        function selectAll() {
            const verseData = sampleData[currentBook][currentChapter][currentVerse];
            selectedTokens.clear();
            for (let i = 0; i < verseData.tokens.length; i++) {
                selectedTokens.add(i);
            }
            renderVerse();
        }

        // Update results
        function updateResults() {
            const verseData = sampleData[currentBook][currentChapter][currentVerse];
            const checkedMethods = getCheckedMethods();
            
            // Get selected text or full verse
            let text = '';
            if (selectedTokens.size > 0) {
                const selectedWords = [];
                selectedTokens.forEach(index => {
                    selectedWords.push(verseData.tokens[index].t);
                });
                text = selectedWords.join(' ');
            } else {
                text = verseData.text_letters_only;
            }
            // Apply transformation to the text if one is selected
            let calcText = text;
            if (currentTransform && currentTransform !== 'none') {
                calcText = GematriaEngine.applyTransform(text, currentTransform);
            }
            
            // Update selection table
            const selectionResults = document.getElementById('selectionResults');
            selectionResults.innerHTML = '';
            
            checkedMethods.forEach(method => {
                // Determine which text to use for this method.  When a
                // transformation is selected we want the standard and milui
                // methods to run on the transformed text (calcText), but the
                // transformation methods themselves (e.g. Atbash, Albam) should
                // operate on the original text to avoid applying the cipher
                // twice.  Live methods always use the transformed text since
                // they derive from Hechrachi sums.
                let inputForMethod = calcText;
                const transformMethods = ['atbash','albam','achbi','avgad','atbach','ayak_bachar','achas_beta','reverse_avgad'];
                if (currentTransform && currentTransform !== 'none' && transformMethods.includes(method)) {
                    inputForMethod = text;
                }
                const value = GematriaEngine.calculate(inputForMethod, method);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${getMethodLabel(method)}</td>
                    <td class="value-cell">${value.toLocaleString()}</td>
                `;
                selectionResults.appendChild(row);
            });
            
            // Update word details
            const wordDetails = document.getElementById('wordDetails');
            wordDetails.innerHTML = '';
            
            if (selectedTokens.size > 0) {
                selectedTokens.forEach(index => {
                    const token = verseData.tokens[index];
                    // Apply transform to individual word for display and calculation
                    let displayWord = token.t;
                    if (currentTransform && currentTransform !== 'none') {
                        displayWord = GematriaEngine.applyTransform(token.t, currentTransform);
                    }
                    const value = GematriaEngine.calculate(displayWord, 'hechrachi');
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${displayWord}</td>
                        <td class="value-cell">${value.toLocaleString()}</td>
                    `;
                    wordDetails.appendChild(row);
                });
            }
        }

        // Get checked methods
        function getCheckedMethods() {
            const methods = [];
            document.querySelectorAll('.method-checkbox input:checked').forEach(checkbox => {
                methods.push(checkbox.value);
            });
            return methods;
        }

        // Get method label
        function getMethodLabel(method) {
            const labels = {
                hechrachi: 'Hechrachi (Standard)',
                gadol: 'Gadol (Large)',
                siduri: 'Siduri (Ordinal)',
                katan: 'Katan (Small)',
                perati: 'Perati (Squared)',
                meshulash: 'Meshulash (Cubed)',
                kidmi: 'Kidmi (Triangular)',
                mispari: 'Mispari (Spelled)',
                boneh: 'Bone\'eh (Building)',
                shemi: 'Shemi (Letter Names)',
                neelam: 'Ne\'elam (Hidden)',
                ofanim: 'Ofanim (Endings)',
                atbash: 'Atbash',
                albam: 'Albam',
                achbi: 'Achbi',
                avgad: 'Avgad',
                atbach: 'AtBach',
                ayak_bachar: 'Ayak Bachar',
                achas_beta: 'Achas Beta',
                reverse_avgad: 'Reverse Avgad',
                kolel: 'Kolel (+Words)',
                musafi: 'Musafi (+Letters)',
                klali: 'Klali (Squared Sum)',
                haachor: 'Ha\'achor (Positional)'
            };
            return labels[method] || method;
        }

        // Toggle method group
        function toggleGroup(group, checked) {
            const groupMap = {
                standard: ['hechrachi', 'gadol', 'siduri', 'katan', 'perati', 'meshulash', 'kidmi', 'mispari', 'boneh'],
                milui: ['shemi', 'neelam', 'ofanim'],
                // Transformation methods including additional temurot
                transform: ['atbash', 'albam', 'achbi', 'atbach', 'ayak_bachar', 'achas_beta', 'avgad', 'reverse_avgad'],
                live: ['kolel', 'musafi', 'klali', 'haachor']
            };
            
            const methods = groupMap[group] || [];
            methods.forEach(method => {
                const checkbox = document.querySelector(`input[value="${method}"]`);
                if (checkbox) {
                    checkbox.checked = checked;
                }
            });
            
            updateResults();
        }

        // Calculate live
        function calculateLive() {
            const input = document.getElementById('calculateInput').value;
            if (!input) return;
            
            const checkedMethods = getCheckedMethods();
            let resultsHtml = '<h4>Results for: ' + input + '</h4><table class="gematria-table"><tbody>';
            
            checkedMethods.forEach(method => {
                const value = GematriaEngine.calculate(input, method);
                resultsHtml += `
                    <tr>
                        <td>${getMethodLabel(method)}</td>
                        <td class="value-cell">${value.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            resultsHtml += '</tbody></table>';
            
            // Display results in a temporary modal
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = resultsHtml;
            Object.assign(tempDiv.style, {
                position: 'fixed',
                top: '50%',
                left: '50%',
                transform: 'translate(-50%, -50%)',
                background: 'white',
                padding: '20px',
                borderRadius: '10px',
                boxShadow: '0 10px 30px rgba(0,0,0,0.3)',
                zIndex: 2000,
                maxHeight: '70vh',
                overflow: 'auto'
            });
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Close';
            closeBtn.className = 'btn';
            closeBtn.onclick = () => document.body.removeChild(tempDiv);
            tempDiv.appendChild(closeBtn);
            document.body.appendChild(tempDiv);

            // Also display the input text in the verse display area so users can apply transforms to it
            const verseDisplay = document.getElementById('verseDisplay');
            verseDisplay.innerHTML = '';
            const words = input.trim().split(/\s+/);
            words.forEach((word, idx) => {
                const span = document.createElement('span');
                span.className = 'word-token';
                span.dataset.index = idx;
                span.dataset.word = word;
                // Apply transformation if selected
                let displayWord = word;
                if (currentTransform && currentTransform !== 'none') {
                    displayWord = GematriaEngine.applyTransform(word, currentTransform);
                }
                span.textContent = displayWord;
                verseDisplay.appendChild(span);
            });
            // Update context display with the raw input text
            const contextDiv = document.getElementById('contextDisplay');
            if (contextDiv) {
                contextDiv.textContent = input;
            }
        }

        /**
         * Apply a letter-substitution cipher transformation to the currently displayed verse or typed input.
         * The transformation is selected via the #transformSelect dropdown. Updates the UI accordingly.
         */
        function applyTransformation() {
            const select = document.getElementById('transformSelect');
            currentTransform = select ? select.value : 'none';
            // Re-render verse display to show transformed text
            renderVerse();
        }

        // Milui dialog functions
        function openMiluiDialog() {
            document.getElementById('miluiModal').classList.add('active');
        }

        function closeMiluiDialog() {
            document.getElementById('miluiModal').classList.remove('active');
        }

        function applyMiluiSettings() {
            // Update milui settings based on selections
            const radioGroups = {
                'milui_alef': '◊ê',
                'milui_bet': '◊ë',
                'milui_gimel': '◊í',
                'milui_heh': '◊î',
                'milui_vav': '◊ï'
            };
            
            for (let [groupName, letter] of Object.entries(radioGroups)) {
                const selected = document.querySelector(`input[name="${groupName}"]:checked`);
                if (selected) {
                    GematriaEngine.milui.current[letter] = selected.value;
                }
            }
            
            closeMiluiDialog();
            updateResults();
        }

        function resetMiluiDefaults() {
            GematriaEngine.milui.current = {...GematriaEngine.milui.defaults};
            // Reset radio buttons
            document.querySelectorAll('.milui-choice input[type="radio"]:first-child').forEach(radio => {
                radio.checked = true;
            });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Display mode changes
            document.querySelectorAll('input[name="displayMode"]').forEach(radio => {
                radio.addEventListener('change', renderVerse);
            });
            
            // Method checkboxes
            document.querySelectorAll('.method-checkbox input').forEach(checkbox => {
                checkbox.addEventListener('change', updateResults);
            });
            
            // Navigation controls
            document.getElementById('verseSelect').addEventListener('change', (e) => {
                currentVerse = parseInt(e.target.value);
                renderVerse();
            });
            
            // Initial render
            renderVerse();
        });

        // Close modal when clicking outside
        window.onclick = (event) => {
            const modal = document.getElementById('miluiModal');
            if (event.target === modal) {
                closeMiluiDialog();
            }
        };
    </script>
</body>
</html>